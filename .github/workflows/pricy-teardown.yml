name: Teardown Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DELETE PRICY" to confirm infrastructure teardown'
        required: true
        type: string

env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  DIGITALOCEAN_TOKEN: ${{ secrets.DO_ACCESS_TOKEN }}
  SPACES_ACCESS_KEY_ID: ${{ secrets.DO_SPACES_ACCESS_KEY }}
  SPACES_SECRET_ACCESS_KEY: ${{ secrets.DO_SPACES_SECRET_KEY }}

jobs:
  teardown:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE PRICY'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache-dependency-path: hosting/go.sum

    - name: Setup Pulumi CLI
      uses: pulumi/actions@v4

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DO_ACCESS_TOKEN }}

    - name: Build infrastructure program
      working-directory: hosting
      run: |
        mkdir -p bin
        go mod download
        go build -o bin/cgc-lb-and-cdn .

    - name: Destroy infrastructure
      working-directory: hosting
      run: |
        pulumi stack select dev
        echo "🗑️ Starting infrastructure teardown..." >> $GITHUB_STEP_SUMMARY

        # Set SHA to "teardown" for config validation (actual value doesn't matter for destroy)
        pulumi config set cgc-lb-and-cdn:sha "teardown"

        # Read domain from Pulumi config (has default in Pulumi.yaml)
        DOMAIN=$(pulumi config get cgc-lb-and-cdn:domain || echo "wheeleraiduel.online")
        echo "📋 Domain: $DOMAIN" >> $GITHUB_STEP_SUMMARY

        # Preserve DO Spaces bucket (contains images needed for lite deployment)
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🛡️ Preserving DO Spaces Bucket" >> $GITHUB_STEP_SUMMARY
        echo "DO Spaces bucket and images will be preserved for lite deployment" >> $GITHUB_STEP_SUMMARY

        # Remove Spaces bucket and CDN from Pulumi state (preserve actual resources)
        if pulumi state delete "urn:pulumi:dev::cgc-lb-and-cdn::digitalocean:index/spacesBucket:SpacesBucket::cgc-lb-and-cdn-spaces" 2>/dev/null; then
          echo "  ✅ Removed Spaces bucket from state (preserving actual bucket)" >> $GITHUB_STEP_SUMMARY
        else
          echo "  ℹ️ Spaces bucket not in state (may have been manually created)" >> $GITHUB_STEP_SUMMARY
        fi

        if pulumi state delete "urn:pulumi:dev::cgc-lb-and-cdn::digitalocean:index/cdn:Cdn::cgc-lb-and-cdn-cdn" 2>/dev/null; then
          echo "  ✅ Removed CDN from state (preserving CDN configuration)" >> $GITHUB_STEP_SUMMARY
        else
          echo "  ℹ️ CDN not in state" >> $GITHUB_STEP_SUMMARY
        fi

        # Clean up auto-created DNS records (created by Let's Encrypt validation)
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🧹 Cleaning up auto-created DNS records" >> $GITHUB_STEP_SUMMARY

        # List all DNS records for debugging
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        doctl compute domain records list "$DOMAIN" --format ID,Type,Name --no-header >> $GITHUB_STEP_SUMMARY || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

        # Get all A and AAAA records for apex domain
        # Name field for apex can be "@", ".", the full domain, or empty
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Looking for apex A/AAAA records (excluding 'www' subdomain)..." >> $GITHUB_STEP_SUMMARY

        APEX_A_RECORDS=$(doctl compute domain records list "$DOMAIN" --format ID,Type,Name --no-header | \
          grep -E "^\s*[0-9]+\s+A\s+" | \
          grep -v "www" | \
          awk '{print $1}' || true)

        APEX_AAAA_RECORDS=$(doctl compute domain records list "$DOMAIN" --format ID,Type,Name --no-header | \
          grep -E "^\s*[0-9]+\s+AAAA\s+" | \
          grep -v "www" | \
          awk '{print $1}' || true)

        # Delete apex A records
        if [ -n "$APEX_A_RECORDS" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          for record_id in $APEX_A_RECORDS; do
            echo "  🗑️ Deleting A record (ID: $record_id)" >> $GITHUB_STEP_SUMMARY
            doctl compute domain records delete "$DOMAIN" "$record_id" --force || true
          done
        else
          echo "  ℹ️ No apex A records found to delete" >> $GITHUB_STEP_SUMMARY
        fi

        # Delete apex AAAA records
        if [ -n "$APEX_AAAA_RECORDS" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          for record_id in $APEX_AAAA_RECORDS; do
            echo "  🗑️ Deleting AAAA record (ID: $record_id)" >> $GITHUB_STEP_SUMMARY
            doctl compute domain records delete "$DOMAIN" "$record_id" --force || true
          done
        else
          echo "  ℹ️ No apex AAAA records found to delete" >> $GITHUB_STEP_SUMMARY
        fi

        # Try to destroy all resources
        pulumi destroy --yes || DESTROY_FAILED=true

        # Handle resources that may fail to delete
        if [ "$DESTROY_FAILED" = "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⚠️ Cleanup Issues Detected" >> $GITHUB_STEP_SUMMARY

          # Remove VPC from state if deletion failed
          if pulumi state delete "urn:pulumi:dev::cgc-lb-and-cdn::digitalocean:index/vpc:Vpc::cgc-lb-and-cdn-vpc" 2>/dev/null; then
            echo "  🔧 Removed VPC from Pulumi state (VPC cannot be deleted via API)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "❌ Infrastructure teardown failed - please check errors above" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          # If only VPC deletion failed (expected), remove it from state
          if pulumi state delete "urn:pulumi:dev::cgc-lb-and-cdn::digitalocean:index/vpc:Vpc::cgc-lb-and-cdn-vpc" 2>/dev/null; then
            echo "🔧 Removed VPC from Pulumi state (VPC cannot be deleted - this is normal)" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Infrastructure teardown complete!" >> $GITHUB_STEP_SUMMARY
        echo "💰 Monthly cost savings: ~\$63/month" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🛡️ Preserved Resources" >> $GITHUB_STEP_SUMMARY
        echo "The following resources were **preserved** for lite deployment:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ **DO Spaces bucket** 'cgc-lb-and-cdn-content' (~\$5/month)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ **All images** in /images/ directory" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ **CDN configuration** for fast image delivery" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "These resources are needed for the lite deployment on GitHub Pages." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📋 Remaining Resources (Free)" >> $GITHUB_STEP_SUMMARY
        echo "- VPC remains (cannot be deleted - this is normal and free)" >> $GITHUB_STEP_SUMMARY
        echo "- DNS NS records remain (nameserver records for your domain)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 💡 Total Monthly Cost After Teardown" >> $GITHUB_STEP_SUMMARY
        echo "- DO Spaces + CDN: \$5/month (needed for lite deployment)" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Pages: \$0/month (completely free)" >> $GITHUB_STEP_SUMMARY
        echo "- **Total: \$5/month** (down from \$68/month)" >> $GITHUB_STEP_SUMMARY
      env:
        PULUMI_STACK: dev

  teardown-failed:
    name: Teardown Confirmation Required
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'DELETE PRICY'

    steps:
    - name: Confirmation failed
      run: |
        echo "❌ Teardown cancelled - confirmation required" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "To destroy infrastructure, type exactly: **DELETE PRICY**" >> $GITHUB_STEP_SUMMARY
        echo "This safety measure prevents accidental deletion and confusion with cheap teardown." >> $GITHUB_STEP_SUMMARY
        exit 1