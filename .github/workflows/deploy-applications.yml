name: Deploy Applications

on:
  workflow_run:
    workflows: ["Deploy Infrastructure"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  DIGITALOCEAN_TOKEN: ${{ secrets.DO_ACCESS_TOKEN }}

jobs:
  deploy-backend:
    name: Deploy Backend Application
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache-dependency-path: backend/go.sum

    - name: Setup Pulumi CLI
      uses: pulumi/actions@v4

    - name: Get infrastructure outputs
      working-directory: hosting
      run: |
        pulumi stack select dev
        echo "BACKEND_IP=$(pulumi stack output backendDropletIp)" >> $GITHUB_ENV
        echo "FRONTEND_IP=$(pulumi stack output frontendDropletIp)" >> $GITHUB_ENV
        echo "DO_SPACES_BUCKET=$(pulumi stack output spacesBucketName)" >> $GITHUB_ENV
        echo "DO_SPACES_ENDPOINT=$(pulumi stack output spacesBucketEndpoint)" >> $GITHUB_ENV
        echo "DO_VALKEY_HOST=$(pulumi stack output valkeyClusterHost)" >> $GITHUB_ENV
        echo "DO_VALKEY_PORT=$(pulumi stack output valkeyClusterPort)" >> $GITHUB_ENV
        echo "DO_VALKEY_URI=$(pulumi stack output valkeyClusterUri)" >> $GITHUB_ENV

    - name: Deploy backend application
      run: |
        echo "## Backend Deployment Starting" >> $GITHUB_STEP_SUMMARY
        echo "Building and deploying Go backend application..." >> $GITHUB_STEP_SUMMARY

        # Build the Go application locally
        cd backend
        go mod tidy
        GOOS=linux GOARCH=amd64 go build -o cgc-backend cmd/server/main.go

        # Create deployment archive
        tar -czf ../backend-deploy.tar.gz cgc-backend
        cd ..

        echo "✅ Backend application built and packaged" >> $GITHUB_STEP_SUMMARY
        echo "Backend will be deployed via droplet user-data script" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "- Backend IP: ${{ env.BACKEND_IP }}" >> $GITHUB_STEP_SUMMARY
        echo "- DO Spaces Bucket: ${{ env.DO_SPACES_BUCKET }}" >> $GITHUB_STEP_SUMMARY
        echo "- DO Spaces Endpoint: ${{ env.DO_SPACES_ENDPOINT }}" >> $GITHUB_STEP_SUMMARY
        echo "- DO Valkey Host: ${{ env.DO_VALKEY_HOST }}" >> $GITHUB_STEP_SUMMARY
        echo "- DO Valkey Port: ${{ env.DO_VALKEY_PORT }}" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Frontend Application
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Setup Pulumi CLI
      uses: pulumi/actions@v4

    - name: Get infrastructure outputs
      working-directory: hosting
      run: |
        pulumi stack select dev
        echo "BACKEND_IP=$(pulumi stack output backendDropletIp)" >> $GITHUB_ENV
        echo "FRONTEND_IP=$(pulumi stack output frontendDropletIp)" >> $GITHUB_ENV
        echo "LB_IP=$(pulumi stack output loadBalancerIp)" >> $GITHUB_ENV

    - name: Deploy frontend application
      run: |
        echo "## Frontend Deployment Starting" >> $GITHUB_STEP_SUMMARY
        echo "Building and preparing Next.js frontend application..." >> $GITHUB_STEP_SUMMARY

        # Build the Next.js application
        cd frontend
        npm ci
        npm run build

        # Create deployment archive
        tar -czf ../frontend-deploy.tar.gz .next public package.json package-lock.json ecosystem.config.js
        cd ..

        echo "✅ Frontend application built and packaged" >> $GITHUB_STEP_SUMMARY
        echo "Frontend will be deployed via droplet user-data script" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend IP: ${{ env.FRONTEND_IP }}" >> $GITHUB_STEP_SUMMARY
        echo "- Load Balancer IP: ${{ env.LB_IP }}" >> $GITHUB_STEP_SUMMARY

    - name: Deployment summary
      run: |
        echo "## 🚀 Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🌐 Access URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Primary Application**: http://${{ env.LB_IP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend API** (private): http://${{ env.BACKEND_IP }}:8080" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend** (private): http://${{ env.FRONTEND_IP }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔍 Health Checks" >> $GITHUB_STEP_SUMMARY
        echo "- Backend Health: http://${{ env.BACKEND_IP }}:8080/health" >> $GITHUB_STEP_SUMMARY
        echo "- Load Balancer Health: Check DigitalOcean dashboard" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 Infrastructure" >> $GITHUB_STEP_SUMMARY
        echo "- **Database**: Valkey cluster at ${{ env.DO_VALKEY_HOST }}:${{ env.DO_VALKEY_PORT }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Storage**: DigitalOcean Spaces at ${{ env.DO_SPACES_ENDPOINT }}" >> $GITHUB_STEP_SUMMARY
        echo "- **CDN**: Integrated with Spaces for fast image delivery" >> $GITHUB_STEP_SUMMARY